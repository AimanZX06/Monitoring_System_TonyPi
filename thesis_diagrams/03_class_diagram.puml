@startuml TonyPi_Class_Diagram

title TonyPi Robot Monitoring System - Class Diagram

skinparam linetype ortho
skinparam nodesep 60
skinparam ranksep 50

skinparam class {
    BackgroundColor White
    BorderColor Black
}

skinparam package {
    BackgroundColor<<Frontend>> LightBlue
    BackgroundColor<<Backend>> LightGreen
    BackgroundColor<<Database>> LightYellow
    BackgroundColor<<Monitoring>> Pink
    BackgroundColor<<RobotClient>> Orange
    BackgroundColor<<MQTT>> LightCoral
}

' ========== FRONTEND LAYER ==========

package "Frontend Layer" <<Frontend>> {
    
    class "ReactApp" as ReactApp {
        - router: BrowserRouter
        - authContext: AuthContext
        - toastContext: ToastContext
        ..
        + render(): JSX.Element
        + initializeApp(): void
    }
    
    class "Dashboard" as Dashboard {
        - robots: Robot[]
        - systemStatus: SystemStatus
        - alerts: Alert[]
        ..
        + fetchRobots(): Promise<Robot[]>
        + displayStats(): void
        + refreshData(): void
    }
    
    class "MonitoringView" as MonitoringView {
        - selectedRobot: Robot
        - telemetryData: TelemetryData
        - websocket: WebSocket
        ..
        + subscribeToTelemetry(): void
        + updateCharts(data): void
        + sendCommand(cmd): void
    }
    
    class "SSHTerminal" as SSHTerminal {
        - terminal: XTerm
        - websocket: WebSocket
        - robotHost: string
        ..
        + connect(robotId): void
        + sendInput(data): void
        + onData(callback): void
        + disconnect(): void
    }
    
    class "AlertsView" as AlertsView {
        - alerts: Alert[]
        - thresholds: Threshold[]
        ..
        + fetchAlerts(): Promise<Alert[]>
        + acknowledgeAlert(id): void
        + resolveAlert(id): void
        + configureThreshold(): void
    }
    
    class "ReportsView" as ReportsView {
        - reports: Report[]
        - aiStatus: AIStatus
        ..
        + generateReport(): void
        + exportPDF(id): void
        + requestAIAnalysis(): void
    }
}

' ========== BACKEND LAYER ==========

package "Backend Layer" <<Backend>> {
    
    class "FastAPIApp" as FastAPIApp {
        - app: FastAPI
        - db_session: Session
        - mqtt_client: MQTTClient
        - scheduler: APScheduler
        ..
        + startup(): void
        + shutdown(): void
        + get_db_session(): Session
    }
    
    class "RobotDataRouter" as RobotDataRouter {
        + get_robot_status(): List<Robot>
        + get_sensors(robot_id): SensorData
        + get_latest_data(robot_id): Dict
        + post_command(cmd): Response
        + get_servos(robot_id): ServoData
    }
    
    class "AlertsRouter" as AlertsRouter {
        + get_alerts(): List<Alert>
        + create_alert(data): Alert
        + acknowledge_alert(id): Alert
        + resolve_alert(id): Alert
        + configure_threshold(data): Threshold
    }
    
    class "ReportsRouter" as ReportsRouter {
        + get_reports(): List<Report>
        + create_report(data): Report
        + get_ai_status(): AIStatus
        + generate_ai_report(): Report
    }
    
    class "UsersRouter" as UsersRouter {
        + login(credentials): Token
        + get_current_user(): User
        + create_user(data): User
        + update_user(id, data): User
        + delete_user(id): void
    }
    
    class "SSHRouter" as SSHRouter {
        - ssh_manager: AsyncSSH
        ..
        + websocket_terminal(ws, host): void
        + create_session(host): SSHSession
        + stream_output(ws): void
    }
    
    class "MQTTService" as MQTTService {
        - client: paho.Client
        - broker_host: string
        - broker_port: int
        ..
        + connect(): void
        + subscribe(topic, callback): void
        + publish(topic, payload): void
        + handle_message(msg): void
    }
    
    class "InfluxDBService" as InfluxDBService {
        - client: InfluxDBClient
        - bucket: string
        - org: string
        ..
        + write_point(measurement, data): void
        + query_range(start, end): ResultSet
        + aggregate_metrics(interval): List
    }
}

' ========== DATA MODELS ==========

package "Data Models" <<Database>> {
    
    class "Robot" as RobotModel {
        + id: int
        + robot_id: string
        + name: string
        + status: RobotStatus
        + ip_address: string
        + location: JSON
        + last_seen: datetime
        + settings: JSON
        + is_active: boolean
    }
    
    class "Alert" as AlertModel {
        + id: int
        + robot_id: string
        + alert_type: AlertType
        + severity: Severity
        + title: string
        + message: text
        + value: float
        + threshold: float
        + acknowledged: boolean
        + resolved: boolean
        + created_at: datetime
    }
    
    class "User" as UserModel {
        + id: string
        + username: string
        + email: string
        + password_hash: string
        + role: UserRole
        + is_active: boolean
        + created_at: datetime
    }
    
    class "Job" as JobModel {
        + id: int
        + robot_id: string
        + task_name: string
        + status: JobStatus
        + percent_complete: float
        + start_time: datetime
        + end_time: datetime
    }
    
    class "Report" as ReportModel {
        + id: int
        + title: string
        + robot_id: string
        + report_type: ReportType
        + data: JSON
        + file_path: string
        + created_at: datetime
    }
    
    enum "RobotStatus" as RobotStatus {
        ONLINE
        OFFLINE
        ERROR
        MAINTENANCE
    }
    
    enum "Severity" as Severity {
        INFO
        WARNING
        CRITICAL
    }
    
    enum "UserRole" as UserRole {
        ADMIN
        OPERATOR
        VIEWER
    }
}

' ========== ROBOT CLIENT LAYER ==========

package "Robot Client Layer" <<RobotClient>> {
    
    interface "ISensor" as ISensor {
        + cleanup(): void
    }
    
    interface "IController" as IController {
        + start(): void
        + stop(): void
    }
    
    class "TonyPiClient" as TonyPiClient {
        - mqtt_client: paho.Client
        - robot_id: string
        - hardware_available: boolean
        ..
        + connect_mqtt(): void
        + publish_telemetry(): void
        + handle_command(cmd): void
        + start(): void
        + stop(): void
    }
    
    class "MainController" as MainController {
        - vision_controller: VisionController
        - movement_controller: MovementController
        - tts_provider: TTSProvider
        - running: boolean
        ..
        + main(): void
        + process_command(cmd): void
        + inference_worker(): void
    }
    
    class "VisionController" as VisionController {
        - model: YOLO
        - camera: Camera
        - is_locked: boolean
        ..
        + detect(frame): Tuple
        + get_navigation_command(): string
        + start(): void
        + stop(): void
    }
    
    class "MovementController" as MovementController {
        - current_position: string
        - qr_navigation: QRNavigation
        - action_module: ActionModule
        ..
        + navigate_to_station(id): boolean
        + follow(direction): void
        + avoid_obstacle(): void
        + stop_movement(): void
    }
    
    class "UltrasonicSensor" as UltrasonicSensor {
        - distance_history: List
        - threshold: int
        ..
        + get_distance(): float
        + is_obstacle_detected(): boolean
        + cleanup(): void
    }
    
    class "LightSensor" as LightSensor {
        - pin: int
        - initialized: boolean
        ..
        + is_dark(): boolean
        + cleanup(): void
    }
    
    class "ServoManager" as ServoManager {
        - board: Board
        - servos: List<Servo>
        ..
        + get_position(id): float
        + get_temperature(id): float
        + get_voltage(id): float
        + set_position(id, angle): void
    }
}

' ========== RELATIONSHIPS ==========

' Frontend relationships
ReactApp *-- Dashboard
ReactApp *-- MonitoringView
ReactApp *-- AlertsView
ReactApp *-- ReportsView
MonitoringView *-- SSHTerminal

' Backend relationships
FastAPIApp *-- RobotDataRouter
FastAPIApp *-- AlertsRouter
FastAPIApp *-- ReportsRouter
FastAPIApp *-- UsersRouter
FastAPIApp *-- SSHRouter
FastAPIApp o-- MQTTService
FastAPIApp o-- InfluxDBService

' Model relationships
RobotModel -- RobotStatus
AlertModel -- Severity
UserModel -- UserRole
AlertModel "many" --> "1" RobotModel
JobModel "many" --> "1" RobotModel
ReportModel "many" --> "1" RobotModel

' Robot Client relationships
ISensor <|.. UltrasonicSensor
ISensor <|.. LightSensor
IController <|.. MainController
IController <|.. VisionController
IController <|.. MovementController

TonyPiClient *-- MainController
MainController *-- VisionController
MainController *-- MovementController
MovementController o-- UltrasonicSensor
TonyPiClient o-- ServoManager
TonyPiClient o-- LightSensor

' Cross-layer dependencies
Dashboard ..> RobotDataRouter : HTTP
MonitoringView ..> MQTTService : WebSocket
AlertsView ..> AlertsRouter : HTTP
ReportsView ..> ReportsRouter : HTTP
TonyPiClient ..> MQTTService : MQTT Pub/Sub

@enduml
